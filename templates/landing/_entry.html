{% if craft.request.isAjax %}
{% set layout = "components/_ajaxLayout" %}
{% else %}
{% set layout = "components/_layout" %}
{% endif %}

{% extends layout %}

{% block content %}


<div class="projectNavigation {% if craft.request.isAjax == false %}open{% endif %} pink">
	<a {% if craft.request.isAjax == false %} href="/" {% endif %} class="backButton">
		<svg width="46" height="31" viewbox="0 0 46 31" xmlns="http://www.w3.org/2000/svg">
			<path fill="#FFF" d="M46 13.563H7.369L18.124 2.732 15.392 0 0 15.5 15.392 31l2.712-2.732L7.37 17.438H46z"
				fill-rule="evenodd" /></svg>
	</a>
</div>


<script src="https://cdn.tailwindcss.com"></script>

<script defer src="https://unpkg.com/alpinejs@3.10.2/dist/cdn.min.js"></script>

<script defer src="https://unpkg.com/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>

<!-- MailerLite Universal -->
<script>
(function(m,a,i,l,e,r){ m['MailerLiteObject']=e;function f(){
var c={ a:arguments,q:[]};var r=this.push(c);return "number"!=typeof r?r:f.bind(c.q);}
f.q=f.q||[];m[e]=m[e]||f.bind(f.q);m[e].q=m[e].q||f.q;r=a.createElement(i);
var _=a.getElementsByTagName(i)[0];r.async=1;r.src=l+'?v'+(~~(new Date().getTime()/1000000));
_.parentNode.insertBefore(r,_);})(window, document, 'script', 'https://static.mailerlite.com/js/universal.js', 'ml');

var ml_account = ml('accounts', '3681068', 'x6c1c9m1j7', 'load');
</script>
<!-- End MailerLite Universal -->

<div x-data="counter()" @getmsch.window="handleMSCH" class="detailContentContainer pink">

	{% include '/components/_landingHeader' %}

	{# <header class="detail contentDetail">
		        <div class="navBarContainer">
		            <div class="grid-x grid-padding-x align-middle">
		                <div class="cell small-12 large-4">
		                    <a {% if craft.request.isAjax == false %}href="/"{% endif %} class="backButton">
		                        <svg class="logo" width="219" height="82" viewbox="0 0 219 82" preserveAspectRatio="xMinYMin meet">
		                            <path  class="name-tag" fill="#000" stroke="#000" stroke-miterlimit="10" d="M48.156,41.64 C51.812,42.807 54.804,45.057 57.131,48.39 C59.457,51.724 60.621,55.516 60.621,59.766 C60.621,66.682 58.398,71.995 53.952,75.703 C49.506,79.411 43.253,81.266 35.192,81.266 L0.043,81.266 L0.043,4.516 L32.826,4.516 C40.886,4.516 47.16,6.307 51.647,9.891 C56.134,13.474 58.378,18.641 58.378,25.391 C58.378,29.391 57.402,32.828 55.448,35.703 C53.496,38.578 51.065,40.557 48.157,41.641 L48.156,41.64 Z M19.114,34.89 L30.58,34.89 C36.563,34.89 39.554,32.557 39.554,27.89 C39.554,23.307 36.563,21.016 30.58,21.016 L19.114,21.016 L19.114,34.89 Z M19.114,49.89 L19.114,64.766 L32.575,64.766 C35.318,64.766 37.457,64.099 38.995,62.766 C40.532,61.432 41.301,59.641 41.301,57.391 C41.301,55.057 40.531,53.224 38.995,51.891 C37.457,50.557 35.318,49.891 32.575,49.891 L19.114,49.891 L19.114,49.89 Z M104.122,43.64 C101.878,42.474 99.178,41.89 96.02,41.89 C90.453,41.89 87.129,44.016 86.048,48.266 L86.048,81.266 L66.48,81.266 L66.48,25.016 L86.05,25.016 L86.05,30.016 C89.124,25.849 93.362,25.141 98.763,25.141 C101.173,25.141 103.810819,25.8440117 104.123,26.141 C104.33112,26.3389922 104.330787,32.1719922 104.122,43.64 Z M129.052,25.016 L129.052,81.266 L109.482,81.266 L109.482,25.016 L129.052,25.016 Z M174.173,81.266 L160.462,60.39 L156.722,64.765 L156.722,81.265 L137.153,81.265 L137.153,0.016 L156.723,0.016 L156.723,43.016 L172.428,25.016 L195.986,25.016 L174.672,48.39 L196.609,81.265 L174.173,81.265 L174.173,81.266 Z M196.983,70.391 C196.983,67.141 198.084,64.391 200.286,62.141 C202.488,59.891 205.21,58.766 208.451,58.766 C211.691,58.766 214.434,59.87 216.677,62.078 C218.921,64.286 220.043,67.058 220.043,70.391 C220.043,73.724 218.921,76.516 216.677,78.766 C214.434,81.016 211.691,82.141 208.451,82.141 C205.293,82.141 202.592,81.016 200.349,78.766 C198.105,76.516 196.983,73.724 196.983,70.391 Z"/>
		                        </svg>
		                    </a>
		                </div>
		                <div class="cell large-8">
		                    <div class="detailMenuContainer">
		                        {% include '/components/_pagesMenu' %}
		                    </div>
		                </div>
		            </div>
		        </div>
		    </header>
		#}


	<div x-init="setTimeout(() => humanisticScore++, 42000)"></div>
	<div x-init="setTimeout(() => competitiveScore--, 42000)"></div>
	<div x-init="setTimeout(() => methodicScore++, 42000)"></div>
	<div x-init="setTimeout(() => spontaniousScore--, 42000)"></div>


	{% if entry.landingContentBlocks|length >= 1 %}
	{% for contentBlock in entry.landingContentBlocks.all() %}
	{% include 'contentBlocks/' ~ contentBlock.type %}
	{% endfor %}
	{% endif %}


	{% include '/components/_landingFooter' %}

	<div class="fixed text-xs bottom-0 right-0 transform -translate-y-4 bg-red-100 px-4 py-2 mx-2 shadow-lg rounded-md">
		<div class="text-center">Lead score:
			<span x-text="leadScore"></span>
		</div>
		<div class="grid grid-cols-2">
			<div class="">Hum. score:
				<span x-text="humanisticScore"></span>
			</div>

			<div class="ml-2">Spo.score:
				<span x-text="spontaniousScore"></span>
			</div>

			<div class="">Com. score:
				<span x-text="competitiveScore"></span>
			</div>

			<div class="ml-2">Met.score:
				<span x-text="methodicScore"></span>
			</div>
		</div>
	</div>
</div>

{% set csrfToken = {
    csrfTokenName: craft.app.config.general.csrfTokenName,
    csrfTokenValue: craft.app.request.csrfToken,
} %}

<script>
  window.Craft = {{ csrfToken|json_encode|raw }};

	function counter() {
		return {

		  handleMSCH(event) {
		    if(event.detail != null) {
		      var scores = event.detail.data;
		      this.leadScore = scores.leadScore;
		      this.methodicScore = scores.mScore;
		      this.spontaniousScore = scores.sScore;
		      this.competitiveScore = scores.cScore;
		      this.humanisticScore = scores.hScore;
		    }
		  },

      leadScore: 0,
			humanisticScore: 0,
			competitiveScore: 0,
			spontaniousScore: 0,
			methodicScore: 0,
		};
	}

	function leadScoreEvent(element, action) {
    var data = JSON.parse(element.getAttribute("data-ls"));
    var statsData = {'stats': data[action]};
    sendScore(statsData);
  }

  function sendScore(statsData) {
      let statsCookieData = getLeadScoreCookie();
      if(statsCookieData == '') {
        setLeadScoreCookie(statsData);
        statsCookieData = getLeadScoreCookie();
      }

      statsData[window.Craft.csrfTokenName] = window.Craft.csrfTokenValue;
      statsData['token'] = statsCookieData.token;


      fetch('/actions/profiledata-module/default/write-msch',{
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(statsData)
      })
        .then(response => response.json())
        .then(data => {
          window.dispatchEvent(new CustomEvent('getmsch', {detail: data}));
        });
  }

  function setLeadScoreCookie(leadData, expDays) {
    var leadScoreData = getLeadScoreCookie();
    if(leadScoreData == "") {
      leadData.token = Math.random().toString(36).substr(2)+''+Math.random().toString(36).substr(2);
    }
    var cValue = JSON.stringify(leadData);
    const expires = "expires=0";
    document.cookie = "_ls=" + cValue + "; " + expires + "; path=/";
  }

  function getLeadScoreCookie() {
      let name = "_ls=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(';');
      for(let i = 0; i <ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return JSON.parse(c.substring(name.length, c.length));
        }
      }
      return "";
  }

  const elements = document.querySelectorAll('[data-ls]');
  const events = ['click', 'mouseover'];

  for (i = 0; i < elements.length; i++) {
    for (j = 0; j < events.length; j++) {
      elements[i].addEventListener(events[j], function(event) {
        leadScoreEvent(event.target, event.type)
      },
      {
      once: false
      });
    }
  }

  // SEND DATA TO GET INITIAL SCORE
  sendScore({'stats': [0,0,0,0,0]});

</script>

{% endblock %}